# 要件定義書

## 概要

本文書は、日華（Rihua）コミュニティプラットフォーム向けの包括的なSpring Boot REST APIの開発要件を定義します。このAPIは、モバイルアプリケーション（iOS/Android）とWebベース管理システムの両方のバックエンドとして機能し、日中コミュニティ向けの住居、求人検索、イベント、チケット販売、コミュニティ機能などのサービスを提供します。

システムは多言語対応（中国語簡体字と日本語）をサポートし、高トラフィック負荷を処理し、安全な認証・認可を提供し、決済、通知、ファイルストレージなどの様々な外部サービスと統合する必要があります。

## 要件

### 要件1: 認証・ユーザー管理システム

**ユーザーストーリー:** プラットフォームユーザーとして、安全にアカウント登録、ログイン、アカウント管理を行い、個人向け機能にアクセスしてプライバシーを保護したい。

#### 受入基準

1.  ユーザーがメールアドレスとパスワードで登録する場合、システムはメール認証付きの新規アカウントを作成する
2.  ユーザーがソーシャルログイン（Apple ID、WeChat、Google）で登録する場合、システムはOAuth2で認証し、アカウントを作成/連携する
3.  ユーザーが有効な認証情報でログインする場合、システムはJWTアクセストークンとリフレッシュトークンを発行する
4.  ユーザーのアクセストークンが期限切れになった場合、システムは有効なリフレッシュトークンを使用してトークン更新を許可する
5.  ユーザーがパスワードリセットを要求する場合、システムは安全なリセットリンクをメールで送信する
6.  ユーザーがプロフィールを更新する場合、システムは変更を検証し、監査ログ付きで保存する
7.  ユーザーがアバターをアップロードする場合、システムは画像を処理、検証し、安全に保存する
8.  ユーザーアカウントが停止または禁止されている場合、システムはアクセスを拒否し、適切なエラーを返す

---

### 要件2: イベント・チケット管理システム

**ユーザーストーリー:** イベント主催者として、チケット販売機能付きのイベントを作成・管理し、文化活動を促進して効率的に参加登録を処理したい。

#### 受入基準

1.  認証済みビジネスユーザーがイベントを作成する場合、システムはイベント詳細を検証し、DRAFT状態で保存する
2.  イベントが公開される場合、システムは公開イベント一覧で表示可能にする
3.  ユーザーがイベントを検索する場合、システムはカテゴリ、日付、場所、キーワードに基づいてフィルタリングされた結果を返す
4.  ユーザーがイベント詳細を表示する場合、システムは利用可能なチケット種類を含む完全な情報を表示する
5.  ユーザーがチケットを購入する場合、システムはStripe経由で決済を処理し、QRコードを生成する
6.  チケット購入が完了した場合、システムは確認通知を送信し、在庫を更新する
7.  管理者がイベントを承認/拒否する場合、システムはステータスを更新し、主催者に通知する
8.  イベント定員に達した場合、システムはそれ以上のチケット販売を防止する

---

### 要件3: 住居検索・管理システム

**ユーザーストーリー:** 住居を探しているユーザーとして、賃貸・売買物件を検索・閲覧し、外国人対応可能な適切な住居を見つけたい。

#### 受入基準

1.  ユーザーが住居を検索する場合、システムは種類、価格、場所、サイズに基づいてフィルタリングされた結果を返す
2.  ユーザーが住居詳細を表示する場合、システムは位置マップを含む完全な物件情報を表示する
3.  物件所有者が物件を投稿する場合、システムは詳細を検証し、適切なステータスを設定する
4.  ユーザーが物件について問い合わせる場合、システムは物件所有者に通知を送信する
5.  管理者が住居投稿をレビューする場合、システムはステータス更新付きで承認/拒否を許可する
6.  物件が賃貸/売却された場合、システムはステータスを更新し、アクティブリストから削除する
7.  物件リストが期限切れになった場合、システムは自動的にステータスを更新し、所有者に通知する

---

### 要件4: 求人検索・管理システム

**ユーザーストーリー:** 求職者として、ビザサポートや中国語スキルを活かせる職を見つけられるよう、雇用機会を検索したい。

#### 受入基準

1.  ユーザーが求人を検索する場合、システムは種類、給与、場所、ビザサポートに基づいてフィルタリングされた結果を返すものとする
2.  ユーザーが求人詳細を表示する場合、システムは要件を含む完全な求人情報を表示するものとする
3.  雇用主が求人を投稿する場合、システムは詳細を検証し、適切なステータスを設定するものとする
4.  ユーザーが求人に応募する場合、システムは応募を記録し、雇用主に通知するものとする
5.  管理者が求人投稿をレビューする場合、システムはステータス更新付きで承認/拒否を許可するものとする
6.  求人ポジションが埋まった場合、システムはステータスを更新し、アクティブなリストから削除するものとする
7.  求人掲載が期限切れになった場合、システムは自動的にステータスを更新し、雇用主に通知するものとする

---

### 要件5: コミュニティフォーラム・コンテンツ管理

**ユーザーストーリー:** コミュニティメンバーとして、他のメンバーと繋がり、サポートを得られるように、ディスカッションに参加したり、コンテンツを共有したりしたい。

#### 受入基準

1.  ユーザーが投稿を作成する場合、システムはコンテンツを検証し、適切なカテゴリで公開するものとする
2.  ユーザーが投稿を閲覧する場合、システムはソートオプション付きでページ分割された結果を表示するものとする
3.  ユーザーが投稿にコメントする場合、システムはコメントを追加し、投稿者に通知するものとする
4.  ユーザーがコンテンツに「いいね」または「いいね」を取り消す場合、システムはカウンターを更新し、ユーザーインタラクションを追跡するものとする
5.  不適切なコンテンツが報告された場合、システムは管理者レビューのためにフラグを立てるものとする
6.  管理者がコンテンツをモデレートする場合、システムは監査証跡付きで非表示/削除を許可するものとする
7.  コンテンツがポリシーに違反する場合、システムは自動的にレビューのためにフラグを立てるものとする

---

### 要件6: 通知システム

**ユーザーストーリー:** ユーザーとして、重要な更新やアクティビティについて常に情報を得られるよう、関連する通知を受け取りたい。

#### 受入基準

1.  ユーザー関連のイベントが発生した場合、システムは適切な通知を作成するものとする
2.  プッシュ通知が送信される場合、システムはモバイル配信にExpo Push APIを使用するものとする
3.  ユーザーが通知を閲覧する場合、システムは未読数を表示し、既読にすることを許可するものとする
4.  ユーザーが通知設定を構成する場合、システムは各カテゴリの好みを尊重するものとする
5.  管理者が一斉通知を送信する場合、システムは対象となるすべてのユーザーに配信するものとする
6.  通知の配信に失敗した場合、システムは指数バックオフで再試行するものとする

---

### 要件7: ファイル管理システム

**ユーザーストーリー:** ユーザーとして、投稿やリスティングに視覚的なコンテンツを追加できるよう、ファイル（画像、ドキュメント）をアップロード・管理したい。

#### 受入基準

1.  ユーザーがファイルをアップロードする場合、システムはファイルの種類、サイズを検証し、マルウェアをスキャンするものとする
2.  ファイルのアップロードが成功した場合、システムはS3に保存し、安全なURLを返すものとする
3.  ユーザーがファイルを削除する場合、システムはストレージから削除し、参照を更新するものとする
4.  ファイルにアクセスする場合、システムは最適なパフォーマンスのためにCDN経由で提供するものとする
5.  ファイルのアップロードに失敗した場合、システムは適切なエラーメッセージを返すものとする
6.  ファイルがサイズ制限を超えた場合、システムは明確なエラーとともにアップロードを拒否するものとする

---

### 要件8: 管理システム

**ユーザーストーリー:** 管理者として、コンテンツを効果的にモデレートし、ユーザーを管理し、プラットフォームの状態を監視できるよう、包括的な管理ツールが欲しい。

#### 受入基準

1.  管理者がユーザー管理を表示する場合、システムはフィルタリングと検索機能付きのユーザーリストを表示するものとする
2.  管理者がユーザーステータスを変更する場合、システムはアカウントを更新し、アクションをログに記録するものとする
3.  管理者が報告されたコンテンツをレビューする場合、システムはコンテキスト付きのモデレーションキューを表示するものとする
4.  管理者が分析にアクセスする場合、システムはリアルタイムデータを含むKPIダッシュボードを表示するものとする
5.  管理者アクションが実行される場合、システムは包括的な監査ログを作成するものとする
6.  システム設定が変更される場合、システムは適切な承認のもとで検証し、適用するものとする
7.  不正な管理者アクセスが試みられた場合、システムはそれを拒否し、セキュリティイベントをログに記録するものとする

---

### 要件9: セキュリティとコンプライアンス

**ユーザーストーリー:** プラットフォームのステークホルダーとして、ユーザーデータが保護され、プラットフォームが関連規制に準拠するよう、堅牢なセキュリティ対策が欲しい。

#### 受入基準

1.  APIリクエストが行われる場合、システムはHTTPSを強制し、認証トークンを検証するものとする
2.  機密データが保存される場合、システムは保存時および転送時に暗号化するものとする
3.  ユーザー入力が処理される場合、システムはインジェクション攻撃を防ぐためにサニタイズするものとする
4.  レートリミットを超えた場合、システムはリクエストをスロットリングし、適切なエラーを返すものとする
5.  セキュリティイベントが発生した場合、システムはログを記録し、管理者に警告するものとする
6.  個人データの削除が要求された場合、システムはプライバシー規制に準拠するものとする
7.  疑わしいアクティビティが検出された場合、システムは保護措置を実装するものとする

---

### 要件10: パフォーマンスとスケーラビリティ

**ユーザーストーリー:** ユーザーとして、遅延や中断なくプラットフォームを効率的に使用できるよう、高速で信頼性の高いサービスが欲しい。

#### 受入基準

1.  APIリクエストが行われる場合、システムは平均200ミリ秒以内に応答するものとする
2.  データベースクエリが実行される場合、システムは平均100ミリ秒以内に完了するものとする
3.  同時ユーザーがシステムにアクセスする場合、システムは1000以上の同時接続を処理するものとする
4.  頻繁にアクセスされるデータが要求された場合、システムはRedisキャッシュから提供するものとする
5.  システム負荷が増加した場合、システムはサービスの中断なしに水平方向にスケールするものとする
6.  エラーが発生した場合、システムはグレースフルデグラデーションと回復を提供するものとする
7.  パフォーマンスのしきい値を超えた場合、システムは管理者に警告するものとする

---

### 要件11: 統合と外部サービス

**ユーザーストーリー:** プラットフォーム運営者として、プラットフォームが包括的な機能を提供できるよう、外部サービスとのシームレスな統合が欲しい。

#### 受入基準

1.  支払いが処理される場合、システムはStripe APIと安全に統合するものとする
2.  プッシュ通知が送信される場合、システムはExpo Push Notifications APIを使用するものとする
3.  メールが送信される場合、システムは配信にAmazon SESを使用するものとする
4.  位置情報サービスが必要な場合、システムはGoogle Maps APIと統合するものとする
5.  ファイルが保存される場合、システムは適切なアクセス制御を持つAmazon S3を使用するものとする
6.  外部サービスが利用できない場合、システムはフォールバックオプションで適切に処理するものとする

---

### 要件12: 多言語サポート

**ユーザーストーリー:** バイリンガルユーザーとして、好みの言語でプラットフォームを使用できるよう、中国語と日本語の両方をサポートして欲しい。

#### 受入基準

1.  APIレスポンスが返される場合、システムはAccept-Languageヘッダーに基づいて言語固有のコンテンツをサポートするものとする
2.  エラーメッセージが表示される場合、システムはローカライズされたテキストを提供するものとする
3.  通知が送信される場合、システムは受信者の優先言語を使用するものとする
4.  コンテンツが検索される場合、システムは中国語と日本語のテキストを適切に処理するものとする
5.  言語設定が指定されていない場合、システムはデフォルトで中国語（簡体字）を使用するものとする